/* esm.sh - esbuild bundle(jsonpath-plus@7.2.0) denonext production */
import T from"node:vm";var{hasOwnProperty:_}=Object.prototype;function w(t,e){return t=t.slice(),t.push(e),t}function b(t,e){return e=e.slice(),e.unshift(t),e}var S=class extends Error{constructor(e){super('JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)'),this.avoidNew=!0,this.value=e,this.name="NewError"}};function h(t,e,r,u,i){if(!(this instanceof h))try{return new h(t,e,r,u,i)}catch(o){if(!o.avoidNew)throw o;return o.value}typeof t=="string"&&(i=u,u=r,r=e,e=t,t=null);let c=t&&typeof t=="object";if(t=t||{},this.json=t.json||r,this.path=t.path||e,this.resultType=t.resultType||"value",this.flatten=t.flatten||!1,this.wrap=_.call(t,"wrap")?t.wrap:!0,this.sandbox=t.sandbox||{},this.preventEval=t.preventEval||!1,this.parent=t.parent||null,this.parentProperty=t.parentProperty||null,this.callback=t.callback||u||null,this.otherTypeCallback=t.otherTypeCallback||i||function(){throw new TypeError("You must supply an otherTypeCallback callback option with the @other() operator.")},t.autostart!==!1){let o={path:c?t.path:e};c?"json"in t&&(o.json=t.json):o.json=r;let f=this.evaluate(o);if(!f||typeof f!="object")throw new S(f);return f}}h.prototype.evaluate=function(t,e,r,u){let i=this.parent,c=this.parentProperty,{flatten:o,wrap:f}=this;if(this.currResultType=this.resultType,this.currPreventEval=this.preventEval,this.currSandbox=this.sandbox,r=r||this.callback,this.currOtherTypeCallback=u||this.otherTypeCallback,e=e||this.json,t=t||this.path,t&&typeof t=="object"&&!Array.isArray(t)){if(!t.path&&t.path!=="")throw new TypeError('You must supply a "path" property when providing an object argument to JSONPath.evaluate().');if(!_.call(t,"json"))throw new TypeError('You must supply a "json" property when providing an object argument to JSONPath.evaluate().');({json:e}=t),o=_.call(t,"flatten")?t.flatten:o,this.currResultType=_.call(t,"resultType")?t.resultType:this.currResultType,this.currSandbox=_.call(t,"sandbox")?t.sandbox:this.currSandbox,f=_.call(t,"wrap")?t.wrap:f,this.currPreventEval=_.call(t,"preventEval")?t.preventEval:this.currPreventEval,r=_.call(t,"callback")?t.callback:r,this.currOtherTypeCallback=_.call(t,"otherTypeCallback")?t.otherTypeCallback:this.currOtherTypeCallback,i=_.call(t,"parent")?t.parent:i,c=_.call(t,"parentProperty")?t.parentProperty:c,t=t.path}if(i=i||null,c=c||null,Array.isArray(t)&&(t=h.toPathString(t)),!t&&t!==""||!e)return;let a=h.toPathArray(t);a[0]==="$"&&a.length>1&&a.shift(),this._hasParentSelector=null;let s=this._trace(a,e,["$"],i,c,r).filter(function(l){return l&&!l.isParentSelector});return s.length?!f&&s.length===1&&!s[0].hasArrExpr?this._getPreferredOutput(s[0]):s.reduce((l,d)=>{let y=this._getPreferredOutput(d);return o&&Array.isArray(y)?l=l.concat(y):l.push(y),l},[]):f?[]:void 0};h.prototype._getPreferredOutput=function(t){let e=this.currResultType;switch(e){case"all":{let r=Array.isArray(t.path)?t.path:h.toPathArray(t.path);return t.pointer=h.toPointer(r),t.path=typeof t.path=="string"?t.path:h.toPathString(t.path),t}case"value":case"parent":case"parentProperty":return t[e];case"path":return h.toPathString(t[e]);case"pointer":return h.toPointer(t.path);default:throw new TypeError("Unknown result type")}};h.prototype._handleCallback=function(t,e,r){if(e){let u=this._getPreferredOutput(t);t.path=typeof t.path=="string"?t.path:h.toPathString(t.path),e(u,r,t)}};h.prototype._trace=function(t,e,r,u,i,c,o,f){let a;if(!t.length)return a={path:r,value:e,parent:u,parentProperty:i,hasArrExpr:o},this._handleCallback(a,c,"value"),a;let s=t[0],l=t.slice(1),d=[];function y(n){Array.isArray(n)?n.forEach(p=>{d.push(p)}):d.push(n)}if((typeof s!="string"||f)&&e&&_.call(e,s))y(this._trace(l,e[s],w(r,s),e,s,c,o));else if(s==="*")this._walk(e,n=>{y(this._trace(l,e[n],w(r,n),e,n,c,!0,!0))});else if(s==="..")y(this._trace(l,e,r,u,i,c,o)),this._walk(e,n=>{typeof e[n]=="object"&&y(this._trace(t.slice(),e[n],w(r,n),e,n,c,!0))});else{if(s==="^")return this._hasParentSelector=!0,{path:r.slice(0,-1),expr:l,isParentSelector:!0};if(s==="~")return a={path:w(r,s),value:i,parent:u,parentProperty:null},this._handleCallback(a,c,"property"),a;if(s==="$")y(this._trace(l,e,r,null,null,c,o));else if(/^(-?\d*):(-?\d*):?(\d*)$/u.test(s))y(this._slice(s,l,e,r,u,i,c));else if(s.indexOf("?(")===0){if(this.currPreventEval)throw new Error("Eval [?(expr)] prevented in JSONPath expression.");let n=s.replace(/^\?\((.*?)\)$/u,"$1");this._walk(e,p=>{this._eval(n,e[p],p,r,u,i)&&y(this._trace(l,e[p],w(r,p),e,p,c,!0))})}else if(s[0]==="("){if(this.currPreventEval)throw new Error("Eval [(expr)] prevented in JSONPath expression.");y(this._trace(b(this._eval(s,e,r[r.length-1],r.slice(0,-1),u,i),l),e,r,u,i,c,o))}else if(s[0]==="@"){let n=!1,p=s.slice(1,-2);switch(p){case"scalar":(!e||!["object","function"].includes(typeof e))&&(n=!0);break;case"boolean":case"string":case"undefined":case"function":typeof e===p&&(n=!0);break;case"integer":Number.isFinite(e)&&!(e%1)&&(n=!0);break;case"number":Number.isFinite(e)&&(n=!0);break;case"nonFinite":typeof e=="number"&&!Number.isFinite(e)&&(n=!0);break;case"object":e&&typeof e===p&&(n=!0);break;case"array":Array.isArray(e)&&(n=!0);break;case"other":n=this.currOtherTypeCallback(e,r,u,i);break;case"null":e===null&&(n=!0);break;default:throw new TypeError("Unknown value type "+p)}if(n)return a={path:r,value:e,parent:u,parentProperty:i},this._handleCallback(a,c,"value"),a}else if(s[0]==="`"&&e&&_.call(e,s.slice(1))){let n=s.slice(1);y(this._trace(l,e[n],w(r,n),e,n,c,o,!0))}else if(s.includes(",")){let n=s.split(",");for(let p of n)y(this._trace(b(p,l),e,r,u,i,c,!0))}else!f&&e&&_.call(e,s)&&y(this._trace(l,e[s],w(r,s),e,s,c,o,!0))}if(this._hasParentSelector)for(let n=0;n<d.length;n++){let p=d[n];if(p&&p.isParentSelector){let g=this._trace(p.expr,e,p.path,u,i,c,o);if(Array.isArray(g)){d[n]=g[0];let $=g.length;for(let P=1;P<$;P++)n++,d.splice(n,0,g[P])}else d[n]=g}}return d};h.prototype._walk=function(t,e){if(Array.isArray(t)){let r=t.length;for(let u=0;u<r;u++)e(u)}else t&&typeof t=="object"&&Object.keys(t).forEach(r=>{e(r)})};h.prototype._slice=function(t,e,r,u,i,c,o){if(!Array.isArray(r))return;let f=r.length,a=t.split(":"),s=a[2]&&Number.parseInt(a[2])||1,l=a[0]&&Number.parseInt(a[0])||0,d=a[1]&&Number.parseInt(a[1])||f;l=l<0?Math.max(0,l+f):Math.min(f,l),d=d<0?Math.max(0,d+f):Math.min(f,d);let y=[];for(let n=l;n<d;n+=s)this._trace(b(n,e),r,u,i,c,o,!0).forEach(g=>{y.push(g)});return y};h.prototype._eval=function(t,e,r,u,i,c){this.currSandbox._$_parentProperty=c,this.currSandbox._$_parent=i,this.currSandbox._$_property=r,this.currSandbox._$_root=this.json,this.currSandbox._$_v=e;let o=t.includes("@path");o&&(this.currSandbox._$_path=h.toPathString(u.concat([r])));let f="script:"+t;if(!h.cache[f]){let a=t.replace(/@parentProperty/gu,"_$_parentProperty").replace(/@parent/gu,"_$_parent").replace(/@property/gu,"_$_property").replace(/@root/gu,"_$_root").replace(/@([.\s)[])/gu,"_$_v$1");o&&(a=a.replace(/@path/gu,"_$_path")),h.cache[f]=new this.vm.Script(a)}try{return h.cache[f].runInNewContext(this.currSandbox)}catch(a){throw new Error("jsonPath: "+a.message+": "+t)}};h.cache={};h.toPathString=function(t){let e=t,r=e.length,u="$";for(let i=1;i<r;i++)/^(~|\^|@.*?\(\))$/u.test(e[i])||(u+=/^[0-9*]+$/u.test(e[i])?"["+e[i]+"]":"['"+e[i]+"']");return u};h.toPointer=function(t){let e=t,r=e.length,u="";for(let i=1;i<r;i++)/^(~|\^|@.*?\(\))$/u.test(e[i])||(u+="/"+e[i].toString().replace(/~/gu,"~0").replace(/\//gu,"~1"));return u};h.toPathArray=function(t){let{cache:e}=h;if(e[t])return e[t].concat();let r=[],i=t.replace(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/gu,";$&;").replace(/[['](\??\(.*?\))[\]']/gu,function(c,o){return"[#"+(r.push(o)-1)+"]"}).replace(/\[['"]([^'\]]*)['"]\]/gu,function(c,o){return"['"+o.replace(/\./gu,"%@%").replace(/~/gu,"%%@@%%")+"']"}).replace(/~/gu,";~;").replace(/['"]?\.['"]?(?![^[]*\])|\[['"]?/gu,";").replace(/%@%/gu,".").replace(/%%@@%%/gu,"~").replace(/(?:;)?(\^+)(?:;)?/gu,function(c,o){return";"+o.split("").join(";")+";"}).replace(/;;;|;;/gu,";..;").replace(/;$|'?\]|'$/gu,"").split(";").map(function(c){let o=c.match(/#(\d+)/u);return!o||!o[1]?c:r[o[1]]});return e[t]=i,e[t].concat()};h.prototype.vm=T;export{h as JSONPath};
//# sourceMappingURL=jsonpath-plus.mjs.map