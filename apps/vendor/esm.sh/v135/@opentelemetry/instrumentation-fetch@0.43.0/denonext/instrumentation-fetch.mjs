/* esm.sh - esbuild bundle(@opentelemetry/instrumentation-fetch@0.43.0) denonext production */
import*as s from"/v135/@opentelemetry/api@1.6.0/denonext/api.mjs";import{isWrapped as j,InstrumentationBase as I,safeExecuteInTheMiddle as M}from"/v135/@opentelemetry/instrumentation@0.43.0/denonext/instrumentation.mjs";import*as m from"/v135/@opentelemetry/core@1.17.0/denonext/core.mjs";import*as f from"/v135/@opentelemetry/sdk-trace-web@1.17.0/denonext/sdk-trace-web.mjs";var v;(function(d){d.COMPONENT="component",d.HTTP_ERROR_NAME="http.error_name",d.HTTP_STATUS_TEXT="http.status_text"})(v||(v={}));import{SemanticAttributes as T}from"/v135/@opentelemetry/semantic-conventions@1.17.0/denonext/semantic-conventions.mjs";var E="0.43.0";import{_globalThis as b}from"/v135/@opentelemetry/core@1.17.0/denonext/core.mjs";var U=function(){var d=function(a,t){return d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])},d(a,t)};return function(a,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");d(a,t);function e(){this.constructor=a}a.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}}(),D=300,X=function(d){U(a,d);function a(t){var e=d.call(this,"@opentelemetry/instrumentation-fetch",E,t)||this;return e.component="fetch",e.version=E,e.moduleName=e.component,e._usedResources=new WeakSet,e._tasksCount=0,e}return a.prototype.init=function(){},a.prototype._getConfig=function(){return this._config},a.prototype._addChildSpan=function(t,e){var r=this.tracer.startSpan("CORS Preflight",{startTime:e[f.PerformanceTimingNames.FETCH_START]},s.trace.setSpan(s.context.active(),t));this._getConfig().ignoreNetworkEvents||f.addSpanNetworkEvents(r,e),r.end(e[f.PerformanceTimingNames.RESPONSE_END])},a.prototype._addFinalSpanAttributes=function(t,e){var r=f.parseUrl(e.url);t.setAttribute(T.HTTP_STATUS_CODE,e.status),e.statusText!=null&&t.setAttribute(v.HTTP_STATUS_TEXT,e.statusText),t.setAttribute(T.HTTP_HOST,r.host),t.setAttribute(T.HTTP_SCHEME,r.protocol.replace(":","")),t.setAttribute(T.HTTP_USER_AGENT,navigator.userAgent)},a.prototype._addHeaders=function(t,e){if(!f.shouldPropagateTraceHeaders(e,this._getConfig().propagateTraceHeaderCorsUrls)){var r={};s.propagation.inject(s.context.active(),r),Object.keys(r).length>0&&this._diag.debug("headers inject skipped due to CORS policy");return}if(t instanceof Request)s.propagation.inject(s.context.active(),t.headers,{set:function(i,n,o){return i.set(n,typeof o=="string"?o:String(o))}});else if(t.headers instanceof Headers)s.propagation.inject(s.context.active(),t.headers,{set:function(i,n,o){return i.set(n,typeof o=="string"?o:String(o))}});else{var r={};s.propagation.inject(s.context.active(),r),t.headers=Object.assign({},r,t.headers||{})}},a.prototype._clearResources=function(){this._tasksCount===0&&this._getConfig().clearTimingResources&&(performance.clearResourceTimings(),this._usedResources=new WeakSet)},a.prototype._createSpan=function(t,e){var r;if(e===void 0&&(e={}),m.isUrlIgnored(t,this._getConfig().ignoreUrls)){this._diag.debug("ignoring span as url matches ignored url");return}var i=(e.method||"GET").toUpperCase(),n="HTTP "+i;return this.tracer.startSpan(n,{kind:s.SpanKind.CLIENT,attributes:(r={},r[v.COMPONENT]=this.moduleName,r[T.HTTP_METHOD]=i,r[T.HTTP_URL]=t,r)})},a.prototype._findResourceAndAddNetworkEvents=function(t,e,r){var i=e.entries;if(!i.length){if(!performance.getEntriesByType)return;i=performance.getEntriesByType("resource")}var n=f.getResource(e.spanUrl,e.startTime,r,i,this._usedResources,"fetch");if(n.mainRequest){var o=n.mainRequest;this._markResourceAsUsed(o);var c=n.corsPreFlightRequest;c&&(this._addChildSpan(t,c),this._markResourceAsUsed(c)),this._getConfig().ignoreNetworkEvents||f.addSpanNetworkEvents(t,o)}},a.prototype._markResourceAsUsed=function(t){this._usedResources.add(t)},a.prototype._endSpan=function(t,e,r){var i=this,n=m.millisToHrTime(Date.now()),o=m.hrTime();this._addFinalSpanAttributes(t,r),setTimeout(function(){var c;(c=e.observer)===null||c===void 0||c.disconnect(),i._findResourceAndAddNetworkEvents(t,e,o),i._tasksCount--,i._clearResources(),t.end(n)},D)},a.prototype._patchConstructor=function(){var t=this;return function(e){var r=t;return function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];var c=this,l=f.parseUrl(n[0]instanceof Request?n[0].url:String(n[0])).href,_=n[0]instanceof Request?n[0]:n[1]||{},g=r._createSpan(l,_);if(!g)return e.apply(this,n);var S=r._prepareSpanData(l);function A(p,u){r._applyAttributesAfterFetch(p,_,u),r._endSpan(p,S,{status:u.status||0,statusText:u.message,url:l})}function R(p,u){r._applyAttributesAfterFetch(p,_,u),u.status>=200&&u.status<400?r._endSpan(p,S,u):r._endSpan(p,S,{status:u.status,statusText:u.statusText,url:l})}function O(p,u,h){try{var N=h.clone(),H=h.clone(),C=N.body;if(C){var k=C.getReader(),w=function(){k.read().then(function(y){var P=y.done;P?R(p,H):w()},function(y){A(p,y)})};w()}else R(p,h)}finally{u(h)}}function x(p,u,h){try{A(p,h)}finally{u(h)}}return new Promise(function(p,u){return s.context.with(s.trace.setSpan(s.context.active(),g),function(){return r._addHeaders(_,l),r._tasksCount++,e.apply(c,_ instanceof Request?[_]:[l,_]).then(O.bind(c,g,p),x.bind(c,g,u))})})}}},a.prototype._applyAttributesAfterFetch=function(t,e,r){var i=this,n=this._getConfig().applyCustomAttributesOnSpan;n&&M(function(){return n(t,e,r)},function(o){o&&i._diag.error("applyCustomAttributesOnSpan",o)},!0)},a.prototype._prepareSpanData=function(t){var e=m.hrTime(),r=[];if(typeof PerformanceObserver!="function")return{entries:r,startTime:e,spanUrl:t};var i=new PerformanceObserver(function(n){var o=n.getEntries();o.forEach(function(c){c.initiatorType==="fetch"&&c.name===t&&r.push(c)})});return i.observe({entryTypes:["resource"]}),{entries:r,observer:i,startTime:e,spanUrl:t}},a.prototype.enable=function(){j(fetch)&&(this._unwrap(b,"fetch"),this._diag.debug("removing previous patch for constructor")),this._wrap(b,"fetch",this._patchConstructor())},a.prototype.disable=function(){this._unwrap(b,"fetch"),this._usedResources=new WeakSet},a}(I);export{X as FetchInstrumentation};
//# sourceMappingURL=instrumentation-fetch.mjs.map