/* esm.sh - esbuild bundle(@opentelemetry/otlp-exporter-base@0.43.0) denonext production */
import{diag as B}from"/v135/@opentelemetry/api@1.6.0/denonext/api.mjs";import{ExportResultCode as m,BindOnceFuture as q}from"/v135/@opentelemetry/core@1.17.0/denonext/core.mjs";import{diag as v}from"/v135/@opentelemetry/api@1.6.0/denonext/api.mjs";import{getEnv as P}from"/v135/@opentelemetry/core@1.17.0/denonext/core.mjs";var H=function(t,e){var r=typeof Symbol=="function"&&t[Symbol.iterator];if(!r)return t;var o=r.call(t),n,i=[],a;try{for(;(e===void 0||e-- >0)&&!(n=o.next()).done;)i.push(n.value)}catch(s){a={error:s}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(a)throw a.error}}return i},R=1e4,L=5,g=1e3,A=5e3,F=1.5;function E(t){t===void 0&&(t={});var e={};return Object.entries(t).forEach(function(r){var o=H(r,2),n=o[0],i=o[1];typeof i<"u"?e[n]=String(i):v.warn('Header "'+n+'" has wrong value and will be ignored')}),e}function j(t,e){return t.endsWith("/")||(t=t+"/"),t+e}function D(t){try{var e=new URL(t);return e.pathname===""&&(e.pathname=e.pathname+"/"),e.toString()}catch{return v.warn("Could not parse export URL: '"+t+"'"),t}}function O(t){return typeof t=="number"?t<=0?x(t,R):t:N()}function N(){var t,e=Number((t=P().OTEL_EXPORTER_OTLP_TRACES_TIMEOUT)!==null&&t!==void 0?t:P().OTEL_EXPORTER_OTLP_TIMEOUT);return e<=0?x(e,R):e}function x(t,e){return v.warn("Timeout must be greater than 0",t),e}function X(t){var e=[429,502,503,504];return e.includes(t)}function I(t){if(t==null)return-1;var e=Number.parseInt(t,10);if(Number.isInteger(e))return e>0?e*1e3:-1;var r=new Date(t).getTime()-Date.now();return r>=0?r:0}var y=function(){function t(e){e===void 0&&(e={}),this._sendingPromises=[],this.url=this.getDefaultUrl(e),typeof e.hostname=="string"&&(this.hostname=e.hostname),this.shutdown=this.shutdown.bind(this),this._shutdownOnce=new q(this._shutdown,this),this._concurrencyLimit=typeof e.concurrencyLimit=="number"?e.concurrencyLimit:1/0,this.timeoutMillis=O(e.timeoutMillis),this.onInit(e)}return t.prototype.export=function(e,r){if(this._shutdownOnce.isCalled){r({code:m.FAILED,error:new Error("Exporter has been shutdown")});return}if(this._sendingPromises.length>=this._concurrencyLimit){r({code:m.FAILED,error:new Error("Concurrent export limit reached")});return}this._export(e).then(function(){r({code:m.SUCCESS})}).catch(function(o){r({code:m.FAILED,error:o})})},t.prototype._export=function(e){var r=this;return new Promise(function(o,n){try{B.debug("items to be sent",e),r.send(e,o,n)}catch(i){n(i)}})},t.prototype.shutdown=function(){return this._shutdownOnce.call()},t.prototype.forceFlush=function(){return Promise.all(this._sendingPromises).then(function(){})},t.prototype._shutdown=function(){return B.debug("shutdown started"),this.onShutdown(),this.forceFlush()},t}();import{diag as S}from"/v135/@opentelemetry/api@1.6.0/denonext/api.mjs";var K=function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,n){o.__proto__=n}||function(o,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(o[i]=n[i])},t(e,r)};return function(e,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");t(e,r);function o(){this.constructor=e}e.prototype=r===null?Object.create(r):(o.prototype=r.prototype,new o)}}(),_=function(t){K(e,t);function e(r,o,n){var i=t.call(this,r)||this;return i.name="OTLPExporterError",i.data=n,i.code=o,i}return e}(Error);var T=function(){return T=Object.assign||function(t){for(var e,r=1,o=arguments.length;r<o;r++){e=arguments[r];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t},T.apply(this,arguments)},W=function(t,e){var r=typeof Symbol=="function"&&t[Symbol.iterator];if(!r)return t;var o=r.call(t),n,i=[],a;try{for(;(e===void 0||e-- >0)&&!(n=o.next()).done;)i.push(n.value)}catch(s){a={error:s}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(a)throw a.error}}return i};function U(t,e,r,o,n){if(navigator.sendBeacon(e,new Blob([t],r)))S.debug("sendBeacon - can send",t),o();else{var i=new _("sendBeacon - cannot send "+t);n(i)}}function w(t,e,r,o,n,i){var a,s,f=!1,p=setTimeout(function(){if(clearTimeout(a),f=!0,s.readyState===XMLHttpRequest.DONE){var u=new _("Request Timeout");i(u)}else s.abort()},o),d=function(u,h){u===void 0&&(u=L),h===void 0&&(h=g),s=new XMLHttpRequest,s.open("POST",e);var b={Accept:"application/json","Content-Type":"application/json"};Object.entries(T(T({},b),r)).forEach(function(c){var l=W(c,2),M=l[0],C=l[1];s.setRequestHeader(M,C)}),s.send(t),s.onreadystatechange=function(){if(s.readyState===XMLHttpRequest.DONE&&f===!1)if(s.status>=200&&s.status<=299)S.debug("xhr success",t),n(),clearTimeout(p),clearTimeout(a);else if(s.status&&X(s.status)&&u>0){var c=void 0;h=F*h,s.getResponseHeader("Retry-After")?c=I(s.getResponseHeader("Retry-After")):c=Math.round(Math.random()*(A-h)+h),a=setTimeout(function(){d(u-1,h)},c)}else{var l=new _("Failed to export with XHR (status: "+s.status+")",s.status);i(l),clearTimeout(p),clearTimeout(a)}},s.onabort=function(){if(f){var c=new _("Request Timeout");i(c)}clearTimeout(p),clearTimeout(a)},s.onerror=function(){if(f){var c=new _("Request Timeout");i(c)}clearTimeout(p),clearTimeout(a)}};d()}import{diag as z}from"/v135/@opentelemetry/api@1.6.0/denonext/api.mjs";import{getEnv as G,baggageUtils as Q}from"/v135/@opentelemetry/core@1.17.0/denonext/core.mjs";var J=function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,n){o.__proto__=n}||function(o,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(o[i]=n[i])},t(e,r)};return function(e,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");t(e,r);function o(){this.constructor=e}e.prototype=r===null?Object.create(r):(o.prototype=r.prototype,new o)}}(),V=function(t){J(e,t);function e(r){r===void 0&&(r={});var o=t.call(this,r)||this;return o._useXHR=!1,o._useXHR=!!r.headers||typeof navigator.sendBeacon!="function",o._useXHR?o._headers=Object.assign({},E(r.headers),Q.parseKeyPairsIntoRecord(G().OTEL_EXPORTER_OTLP_HEADERS)):o._headers={},o}return e.prototype.onInit=function(){window.addEventListener("unload",this.shutdown)},e.prototype.onShutdown=function(){window.removeEventListener("unload",this.shutdown)},e.prototype.send=function(r,o,n){var i=this;if(this._shutdownOnce.isCalled){z.debug("Shutdown already started. Cannot send objects");return}var a=this.convert(r),s=JSON.stringify(a),f=new Promise(function(d,u){i._useXHR?w(s,i.url,i._headers,i.timeoutMillis,d,u):U(s,i.url,{type:"application/json"},d,u)}).then(o,n);this._sendingPromises.push(f);var p=function(){var d=i._sendingPromises.indexOf(f);i._sendingPromises.splice(d,1)};f.then(p,p)},e}(y);export{y as OTLPExporterBase,V as OTLPExporterBrowserBase,_ as OTLPExporterError,j as appendResourcePathToUrl,D as appendRootPathToUrlIfNeeded,O as configureExporterTimeout,x as invalidTimeout,E as parseHeaders,w as sendWithXhr};
//# sourceMappingURL=otlp-exporter-base.mjs.map